name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  JAVA_VERSION: '17'

jobs:
  # JUnit Tests
  junit-tests:
    name: "üß™ JUnit Tests"
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        
    - name: Run JUnit Tests
      if: |
        contains(github.event.head_commit.modified, 'payment-dashboard/') ||
        contains(github.event.head_commit.added, 'payment-dashboard/') ||
        github.event_name == 'pull_request'
      run: |
        echo "üß™ Running JUnit tests..."
        cd payment-dashboard
        mvn clean test
        
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: payment-dashboard/target/surefire-reports/

  # Test Node.js Server
  test-nodejs:
    name: "üü¢ Node.js Tests"
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
      
    - name: Skip Node.js tests
      run: echo "‚úÖ No Node.js services to test in new architecture"

  # Build and Push Docker Images
  build-images:
    name: "üê≥ Build Docker Images"
    runs-on: ubuntu-latest
    needs: [junit-tests, test-nodejs]
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name == 'push' &&
      (needs.junit-tests.result == 'success' || needs.junit-tests.result == 'skipped') &&
      (needs.test-nodejs.result == 'success' || needs.test-nodejs.result == 'skipped')
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata for payment-portal
      id: meta-portal
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository_owner }}/hermes-payment-portal
        tags: |
          type=raw,value=latest
          type=sha,prefix={{branch}}-
    
    - name: Build and push payment-portal
      uses: docker/build-push-action@v5
      with:
        context: ./payment-portal
        push: true
        tags: ${{ steps.meta-portal.outputs.tags }}
        labels: ${{ steps.meta-portal.outputs.labels }}
    
    - name: Extract metadata for payment-dashboard
      id: meta-dashboard
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository_owner }}/hermes-payment-dashboard
        tags: |
          type=raw,value=latest
          type=sha,prefix={{branch}}-
    
    - name: Build and push payment-dashboard
      uses: docker/build-push-action@v5
      with:
        context: ./payment-dashboard
        push: true
        tags: ${{ steps.meta-dashboard.outputs.tags }}
        labels: ${{ steps.meta-dashboard.outputs.labels }}
    
    - name: Extract metadata for payment-redis-service
      id: meta-redis-service
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository_owner }}/hermes-payment-redis-service
        tags: |
          type=raw,value=latest
          type=sha,prefix={{branch}}-
    
    - name: Build and push payment-redis-service
      uses: docker/build-push-action@v5
      with:
        context: ./payment-infra/payment-redis-service
        push: true
        tags: ${{ steps.meta-redis-service.outputs.tags }}
        labels: ${{ steps.meta-redis-service.outputs.labels }}

  # Deploy to Shared VM
  deploy:
    name: "üöÄ Deploy to Shared VM"
    runs-on: ubuntu-latest
    needs: [build-images]
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name == 'push'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    
    - name: Deploy Infrastructure
      working-directory: ./payment-infra/terraform
      env:
        TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
        TF_VAR_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
        TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
        TF_VAR_region: ${{ secrets.OCI_REGION }}
        TF_VAR_private_key: ${{ secrets.OCI_PRIVATE_KEY }}
        TF_VAR_compartment_id: ${{ secrets.OCI_COMPARTMENT_ID }}
        TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        TF_VAR_github_token: ${{ secrets.GITHUB_TOKEN }}
        TF_VAR_github_owner: ${{ github.repository_owner }}
        TF_VAR_allowed_ssh_cidr: ${{ secrets.ALLOWED_SSH_CIDR || '0.0.0.0/0' }}
        TF_VAR_allowed_web_cidr: ${{ secrets.ALLOWED_WEB_CIDR || '0.0.0.0/0' }}
      run: |
        terraform init
        terraform apply -auto-approve
        
        INSTANCE_IP=$(terraform output -raw instance_public_ip)
        echo "INSTANCE_IP=$INSTANCE_IP" >> $GITHUB_ENV
        echo "‚úÖ Deployed to $INSTANCE_IP"
    
    - name: Wait for Services
      run: |
        echo "Waiting for services to start..."
        sleep 120
        
        for i in {1..30}; do
          if curl -fsS http://$INSTANCE_IP:8080/health >/dev/null 2>&1; then
            echo "‚úÖ Dashboard healthy"
            exit 0
          fi
          sleep 5
        done
        echo "‚ö†Ô∏è Dashboard did not become healthy"
        exit 1