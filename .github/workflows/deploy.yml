name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  JAVA_VERSION: '17'

jobs:
  # JUnit Tests
  junit-tests:
    name: "üß™ JUnit Tests"
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        
    - name: Run JUnit Tests
      run: |
        echo "üß™ Running JUnit tests..."
        cd client
        mvn clean test
        
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: client/target/surefire-reports/

  # Test Node.js Server
  test-nodejs:
    name: "üü¢ Node.js Tests"
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: server/package-lock.json
        
    - name: Install dependencies
      working-directory: ./server
      run: npm ci
      
    - name: Run tests
      working-directory: ./server
      run: npm test || echo "No tests defined yet"

  # Deploy Infrastructure and Application
  deploy:
    name: "üöÄ Deploy to OCI"
    runs-on: ubuntu-latest
    needs: [junit-tests, test-nodejs]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    
    - name: Setup OCI CLI
      uses: oracle-actions/configure-oci-cli@v1.1
      with:
        user-ocid: ${{ secrets.OCI_USER_OCID }}
        tenancy-ocid: ${{ secrets.OCI_TENANCY_OCID }}
        region: ${{ secrets.OCI_REGION }}
        fingerprint: ${{ secrets.OCI_FINGERPRINT }}
        private-key: ${{ secrets.OCI_PRIVATE_KEY }}
    
    - name: Deploy Infrastructure
      working-directory: ./infra/terraform
      run: |
        terraform init
        terraform plan \
          -var="compartment_id=${{ secrets.OCI_COMPARTMENT_ID }}" \
          -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
          -var="user_ocid=${{ secrets.OCI_USER_OCID }}" \
          -var="fingerprint=${{ secrets.OCI_FINGERPRINT }}" \
          -var="private_key=${{ secrets.OCI_PRIVATE_KEY }}" \
          -var="tenancy_ocid=${{ secrets.OCI_TENANCY_OCID }}" \
          -var="region=${{ secrets.OCI_REGION }}"
        terraform apply -auto-approve \
          -var="compartment_id=${{ secrets.OCI_COMPARTMENT_ID }}" \
          -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
          -var="user_ocid=${{ secrets.OCI_USER_OCID }}" \
          -var="fingerprint=${{ secrets.OCI_FINGERPRINT }}" \
          -var="private_key=${{ secrets.OCI_PRIVATE_KEY }}" \
          -var="tenancy_ocid=${{ secrets.OCI_TENANCY_OCID }}" \
          -var="region=${{ secrets.OCI_REGION }}"
        
        # Get instance IP
        INSTANCE_IP=$(terraform output -raw instance_public_ip)
        echo "INSTANCE_IP=$INSTANCE_IP" >> $GITHUB_ENV
    
    - name: Wait for Services
      run: |
        echo "Waiting for services to start..."
        sleep 180
        
        # Wait for health endpoint
        for i in {1..30}; do
          if curl -f http://$INSTANCE_IP:9292/health; then
            echo "‚úÖ Services ready!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 10
        done
    
    - name: Health Check
      run: |
        curl -f http://$INSTANCE_IP:9292/health || exit 1
        curl -f http://$INSTANCE_IP:9292/ || exit 1
        curl -f http://$INSTANCE_IP:8080/ || exit 1
        
        echo "‚úÖ Deployment successful!"
        echo "üåê Server: http://$INSTANCE_IP:9292"
        echo "üìä Dashboard: http://$INSTANCE_IP:8080"
        echo "üóÑÔ∏è MySQL: $(cd infra/terraform && terraform output -raw mysql_ip)"