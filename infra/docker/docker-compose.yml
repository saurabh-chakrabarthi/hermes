version: '3.8'

services:
  payment-server:
    build:
      context: ../../server
      dockerfile: Dockerfile
    container_name: payment-server
    ports:
      - "9292:9292"
    environment:
      - PORT=9292
      - NODE_ENV=production
      - MONGODB_USER=${MONGODB_USER}
      - MONGODB_PASSWORD=${MONGODB_PASSWORD}
      - MONGODB_CLUSTER=${MONGODB_CLUSTER}
      - MONGODB_DATABASE=${MONGODB_DATABASE}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9292/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  payment-dashboard:
    build:
      context: ../../dashboard
      dockerfile: Dockerfile
    container_name: payment-dashboard
    ports:
      - "8080:8080"
    environment:
      - PAYMENT_SERVER_URL=http://payment-server:9292
    depends_on:
      payment-server:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s