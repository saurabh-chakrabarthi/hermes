#cloud-config
package_update: true
package_upgrade: true

packages:
  - ruby
  - ruby-dev
  - build-essential
  - sqlite3
  - libsqlite3-dev
  - git

runcmd:
  - gem install bundler
  - mkdir -p /home/ubuntu/payment-portal
  - chown ubuntu:ubuntu /home/ubuntu/payment-portal
  - sudo -u ubuntu git clone https://github.com/saurabh-chakrabarthi/hermes.git /home/ubuntu/payment-portal
  - cd /home/ubuntu/payment-portal/server && sudo -u ubuntu bundle install
  - cd /home/ubuntu/payment-portal/server && sudo -u ubuntu bundle exec rake db:create db:migrate
  - cp /home/ubuntu/payment-portal/infra/scripts/payment-server.service /etc/systemd/system/
  - systemctl daemon-reload
  - systemctl enable payment-server
  - systemctl start payment-server
  - ufw allow 9292
  - echo "Setup complete! Server running on port 9292" > /home/ubuntu/setup-complete.log